# ========================================
# VyOS Aggregator â€“ Windows PC (Starlink)
# Production configuration for Hyper-V/VMware
# ========================================

# Interfaces
set interfaces ethernet eth0 address 'dhcp'
set interfaces ethernet eth0 description 'WAN-STARLINK-CGNAT'
set interfaces ethernet eth1 address '192.168.100.1/24'
set interfaces ethernet eth1 description 'LAN-WINDOWS'
set interfaces loopback lo address '100.64.0.1/32'

# IPsec
set vpn ipsec esp-group ESP-VTI lifetime '3600'
set vpn ipsec esp-group ESP-VTI mode 'tunnel'
set vpn ipsec esp-group ESP-VTI pfs 'enable'
set vpn ipsec esp-group ESP-VTI proposal 1 encryption 'aes256'
set vpn ipsec esp-group ESP-VTI proposal 1 hash 'sha256'

set vpn ipsec ike-group IKE-VTI key-exchange 'ikev2'
set vpn ipsec ike-group IKE-VTI lifetime '10800'
set vpn ipsec ike-group IKE-VTI proposal 1 dh-group '14'
set vpn ipsec ike-group IKE-VTI proposal 1 encryption 'aes256'
set vpn ipsec ike-group IKE-VTI proposal 1 hash 'sha256'

set vpn ipsec ipsec-interfaces interface 'eth0'

# Multiple Branches Configuration
set vpn ipsec site-to-site peer BRANCH1 authentication mode 'pre-shared-secret'
set vpn ipsec site-to-site peer BRANCH1 authentication pre-shared-secret 'BranchPSK2025!'
set vpn ipsec site-to-site peer BRANCH1 connection-type 'initiate'
set vpn ipsec site-to-site peer BRANCH1 ike-group 'IKE-VTI'
set vpn ipsec site-to-site peer BRANCH1 local-address 'dhcp'
set vpn ipsec site-to-site peer BRANCH1 remote-address 'BRANCH1_PUBLIC_IP'
set vpn ipsec site-to-site peer BRANCH1 vti bind 'vti10'
set vpn ipsec site-to-site peer BRANCH1 vti esp-group 'ESP-VTI'

set vpn ipsec site-to-site peer BRANCH2 authentication mode 'pre-shared-secret'
set vpn ipsec site-to-site peer BRANCH2 authentication pre-shared-secret 'BranchPSK2025!'
set vpn ipsec site-to-site peer BRANCH2 connection-type 'initiate'
set vpn ipsec site-to-site peer BRANCH2 ike-group 'IKE-VTI'
set vpn ipsec site-to-site peer BRANCH2 local-address 'dhcp'
set vpn ipsec site-to-site peer BRANCH2 remote-address 'BRANCH2_PUBLIC_IP'
set vpn ipsec site-to-site peer BRANCH2 vti bind 'vti20'
set vpn ipsec site-to-site peer BRANCH2 vti esp-group 'ESP-VTI'

# VTI Interfaces
set interfaces vti vti10 address '10.255.10.1/30'
set interfaces vti vti10 description 'VTI-BRANCH1'
set interfaces vti vti10 mtu '1380'

set interfaces vti vti20 address '10.255.20.1/30'
set interfaces vti vti20 description 'VTI-BRANCH2'
set interfaces vti vti20 mtu '1380'

# SD-WAN Configuration
set sdwan interfaces ethernet eth0
set sdwan interfaces vti vti10
set sdwan interfaces vti vti20
set sdwan path-group STARLINK interface 'eth0' weight '10'
set sdwan path-group BRANCH1 interface 'vti10' weight '20'
set sdwan path-group BRANCH2 interface 'vti20' weight '20'

# Health Checks
set sdwan health-check BRANCH1 target 'BRANCH1_PUBLIC_IP'
set sdwan health-check BRANCH1 probe-interval '5'
set sdwan health-check BRANCH1 failure-threshold '3'

set sdwan health-check BRANCH2 target 'BRANCH2_PUBLIC_IP'
set sdwan health-check BRANCH2 probe-interval '5'
set sdwan health-check BRANCH2 failure-threshold '3'

# BGP Configuration
set protocols bgp system-as '65000'
set protocols bgp neighbor 10.255.10.2 remote-as '65001'
set protocols bgp neighbor 10.255.10.2 description 'BRANCH1'
set protocols bgp neighbor 10.255.20.2 remote-as '65002'
set protocols bgp neighbor 10.255.20.2 description 'BRANCH2'

# Advertise local networks
set protocols bgp address-family ipv4-unicast network '192.168.100.0/24'
set protocols bgp address-family ipv4-unicast network '100.64.0.1/32'

# NAT Configuration
set nat source rule 100 outbound-interface 'eth0'
set nat source rule 100 source address '192.168.100.0/24'
set nat source rule 100 translation address 'masquerade'

# Firewall Rules
set firewall ipv4 forward filter rule 10 action 'accept'
set firewall ipv4 forward filter rule 10 state established 'enable'
set firewall ipv4 forward filter rule 10 state related 'enable'

set firewall ipv4 forward filter rule 20 action 'accept'
set firewall ipv4 forward filter rule 20 source address '192.168.0.0/16'
set firewall ipv4 forward filter rule 20 destination address '192.168.0.0/16'

# Management Interface
set service https listen-address '0.0.0.0'
set service https port '443'
set service https api keys key 1 secret 'WindowsAPIKey2025!'

set service ssh listen-address '0.0.0.0'
set service ssh port '22'

# System Configuration
set system host-name 'vyos-aggregator-windows'
set system time-zone 'America/New_York'
set system domain-name 'local'

# Logging
set system syslog global facility all level 'info'
set system syslog host 192.168.100.10 facility all level 'info'

commit
save